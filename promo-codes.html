<!DOCTYPE html>
<html lang="en">
<head>
  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D5YSD14H3P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D5YSD14H3P');
  </script>

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Amazon Promo Codes ‚Äì Global Finds</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    :root{--dark:#111827;--accent:#f97316;--soft:#ffedd5}
    .card{border:1px solid #e5e7eb;border-radius:16px;background:#fff}
    .pill{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:#fff}
    .btn{border-radius:12px;padding:10px 12px;font-weight:800}
    .btn-dark{background:var(--dark);color:var(--accent)}
    .btn-soft{background:var(--soft);color:#9a3412}
    .tag{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:5px 10px;font-size:12px;font-weight:800}
    .tag-off{background:var(--accent);color:#fff}
    .tag-time{background:#eef2ff;color:#3730a3}
    .tag-cat{background:#ecfeff;color:#155e75}
    .tag-brand{background:#f1f5f9;color:#0f172a}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#111827;color:#fff;
      padding:10px 14px;border-radius:12px;font-size:13px;box-shadow:0 10px 30px rgba(0,0,0,.18);opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1}
    .product-card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;overflow:hidden;transition:.2s}
    .product-card:hover{transform:translateY(-3px);box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .price{background:var(--soft);color:#9a3412;font-size:12px;font-weight:800;padding:4px 8px;border-radius:8px}
    .badge{position:absolute;top:10px;left:10px;background:var(--accent);color:#fff;font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px}
    .badge-right{right:10px;left:auto;background:#000;font-size:10px}
  </style>
</head>

<body class="bg-slate-50 text-slate-900">

<div class="bg-slate-800 text-slate-300 text-[10px] py-1 text-center">
  As an Amazon Associate, we earn from qualifying purchases.
</div>

<nav class="bg-white border-b px-4 py-3 sticky top-0 z-50">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-bag-shopping text-orange-500 text-2xl"></i>
      <a href="/" class="text-xl font-extrabold">GLOBAL<span class="text-orange-500">FINDS</span></a>
    </div>

    <a href="/" class="text-sm font-bold text-slate-600 hover:text-slate-900">
      <i class="fa-solid fa-house mr-2"></i>Home
    </a>
  </div>
</nav>

<main class="max-w-7xl mx-auto px-4 py-8">

  <div class="flex items-start justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl md:text-3xl font-black">üéüÔ∏è Amazon Promo Codes</h1>
      <p class="text-slate-500 text-sm mt-2">
        Copy the code, then tap ‚ÄúShop‚Äù to apply it at checkout (eligible items only).
      </p>
    </div>

    <div class="flex items-center gap-2">
      <label class="pill flex items-center gap-2 cursor-pointer">
        <input id="onlyActive" type="checkbox" class="accent-orange-500" checked />
        Active only
      </label>

      <div class="relative">
        <select id="categorySelect"
          class="pill pr-10 outline-none focus:ring-2 focus:ring-orange-300">
        </select>
        <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
      </div>
    </div>
  </div>

  <div id="stats" class="text-xs text-slate-500 mb-4"></div>

  <div id="list" class="space-y-4"></div>

</main>

<div id="toast" class="toast">Copied</div>

<script>
/* =============================
   Config
============================= */
const TRACK_ID = "site_esfinds-20";          // ‚úÖ ‰Ω†ÁöÑ OneLink tag
const PROMO_URL = "promo_codes.json";       // ‚úÖ ‰Ω†Ëá™Â∑±Áª¥Êä§ÁöÑ promo Êï∞ÊçÆ
const PRODUCTS_URL = "products_data_v.json";// ‚úÖ ‰Ω†ÁöÑ Vipon ÂïÜÂìÅ JSON

/* =============================
   Helpers
============================= */
function buildAmazonLink(asin){
  return `https://www.amazon.com/dp/${encodeURIComponent(asin)}?tag=${TRACK_ID}`;
}
function buildAmazonSearchLink(q){
  return `https://www.amazon.com/s?k=${encodeURIComponent(q)}&tag=${TRACK_ID}`;
}
function formatPrice(v){
  return (v === null || v === undefined || v === "") ? "" : Number(v).toFixed(2);
}
function formatRating(v){
  return (v === null || v === undefined || v === "") ? "N/A" : Number(v).toFixed(1);
}
function nowMs(){ return Date.now(); }
function parseMs(iso){
  const t = Date.parse(iso);
  return Number.isFinite(t) ? t : 0;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function showToast(text){
  const t = document.getElementById("toast");
  t.textContent = text;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1200);
}

/* =============================
   ËøáÊúüÈöêËóè / Áä∂ÊÄÅÂà§ÂÆö
============================= */
function promoStatus(p){
  const s = parseMs(p.start_at);
  const e = parseMs(p.end_at);
  const now = nowMs();
  if (e && now > e) return "expired";
  if (s && now < s) return "upcoming";
  return "active";
}
function formatDateShort(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString(undefined, {year:"numeric", month:"short", day:"2-digit"});
  }catch(e){ return iso; }
}

/* =============================
   Promo ‚Üî Vipon ÂïÜÂìÅÂåπÈÖçÈÄªËæëÔºàËá™Âä®Ôºâ
   - ÂÖàÊåâÂìÅÁâåÂÖ≥ÈîÆËØçÔºàtitle contains brandÔºâ
   - ÂÜçÊåâ category_name Áõ∏‰ºº
   - ÂÜçÊåâ‚ÄúÈ´òËØÑÂàÜ‰Ωé‰ª∑‚ÄùÊéíÂ∫èÂèñÂâç N ‰∏™
============================= */
function scoreDeal(p){
  const rating = Number(p.review_rating || 0);
  const reviews = Math.log10((p.review_count || 0) + 1);
  const price = Number(p.price_discount || 999);
  const priceFactor = price > 0 ? 1 / Math.sqrt(price) : 0;
  return rating * reviews * priceFactor;
}

function normalize(s){
  return (s || "").toString().trim().toLowerCase();
}

function matchDealsForPromo(promo, products, limit=6){
  const brand = normalize(promo.brand);
  const cat = normalize(promo.category);

  // 1) Brand matches (strong)
  let brandMatches = products.filter(x => normalize(x.title).includes(brand));

  // 2) Category matches (medium)
  let catMatches = products.filter(x => normalize(x.category_name) === cat);

  // ÂêàÂπ∂ÂéªÈáçÔºàÊåâ asinÔºâ
  const map = new Map();
  [...brandMatches, ...catMatches].forEach(x => {
    if (x.asin) map.set(x.asin, x);
  });

  // Â¶ÇÊûúÂÆåÂÖ®ÂåπÈÖç‰∏çÂà∞ÔºåÂ∞±ÂÅöÂº±ÂåπÈÖçÔºöcategory contains / includes
  if (map.size === 0 && cat){
    products.forEach(x=>{
      const xc = normalize(x.category_name);
      if (xc && (xc.includes(cat) || cat.includes(xc))) {
        if (x.asin) map.set(x.asin, x);
      }
    });
  }

  const list = [...map.values()];

  // ÊéíÂ∫èÔºöÈ´òËØÑÂàÜ‰Ωé‰ª∑‰ºòÂÖà
  list
    .map(x => ({...x, _s: scoreDeal(x)}))
    .sort((a,b)=>b._s - a._s);

  return list.slice(0, limit);
}

/* =============================
   Render UI
============================= */
let promos = [];
let products = [];
let currentCategory = "All";

function renderCategoryDropdown(){
  const sel = document.getElementById("categorySelect");
  const cats = [...new Set(promos.map(p => p.category).filter(Boolean))].sort();

  sel.innerHTML = "";
  const all = document.createElement("option");
  all.value = "All";
  all.textContent = "All Categories";
  sel.appendChild(all);

  cats.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });

  sel.value = currentCategory;
  sel.onchange = () => {
    currentCategory = sel.value;
    renderList();
  };
}

async function copyCode(code){
  try{
    await navigator.clipboard.writeText(code);
    showToast(`Copied: ${code}`);
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = code;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast(`Copied: ${code}`);
  }
}

function promoCard(p){
  const status = promoStatus(p);

  const brand = p.brand || "Brand";
  const category = p.category || "Category";
  const off = Number(p.discount_percent || 0);
  const code = p.promo_code || "";
  const start = p.start_at ? formatDateShort(p.start_at) : "";
  const end = p.end_at ? formatDateShort(p.end_at) : "";

  const deals = matchDealsForPromo(p, products, 6);

  const shopQuery = brand || category;
  const shopUrl = buildAmazonSearchLink(shopQuery);

  return `
  <div class="card p-4 md:p-5">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="flex flex-wrap items-center gap-2">
          <span class="tag tag-off">${off ? off + "% OFF" : "PROMO"}</span>
          <span class="tag tag-brand"><i class="fa-solid fa-tag"></i>${brand}</span>
          <span class="tag tag-cat"><i class="fa-solid fa-layer-group"></i>${category}</span>
          ${status === "upcoming" ? `<span class="tag tag-time"><i class="fa-solid fa-clock"></i>Upcoming</span>` : ""}
          ${status === "expired" ? `<span class="tag tag-time"><i class="fa-solid fa-ban"></i>Expired</span>` : ""}
        </div>

        <div class="text-sm text-slate-600 mt-2">
          ${start ? `<span class="font-semibold text-slate-700">Start:</span> ${start}` : ""}
          ${end ? ` <span class="mx-2 text-slate-300">|</span> <span class="font-semibold text-slate-700">End:</span> ${end}` : ""}
          ${p.note ? ` <span class="mx-2 text-slate-300">|</span> ${p.note}` : ""}
        </div>
      </div>

      <div class="flex flex-col gap-2 shrink-0">
        <button class="btn btn-soft" onclick="copyCodeGlobal('${code}')">
          <i class="fa-regular fa-copy mr-2"></i>${code || "Copy"}
        </button>
        <a class="btn btn-dark text-center" href="${shopUrl}" target="_blank" rel="nofollow"
           onclick="trackShop('${brand}','${code}')">
          <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i>Shop
        </a>
      </div>
    </div>

    ${deals.length ? `
      <div class="mt-4">
        <div class="text-xs font-extrabold text-slate-500 mb-2 uppercase tracking-wide">
          Matching Deals
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3">
          ${deals.map(renderDealMini).join("")}
        </div>
      </div>
    ` : `
      <div class="mt-4 text-sm text-slate-500">
        No matched deals found. Tap <b>Shop</b> and search the brand to find eligible items.
      </div>
    `}
  </div>
  `;
}

function renderDealMini(p){
  const img = p.main_image || "";
  const title = p.title || "";
  const asin = p.asin || "";
  const cur = p.currency || "$";
  const price = formatPrice(p.price_discount);
  const oldp = p.price_original ? `${cur}${formatPrice(p.price_original)}` : "";
  const discount = p.discount_percent ? `-${p.discount_percent}%` : "";

  const rating = formatRating(p.review_rating);
  const count = p.review_count || 0;

  const url = asin ? buildAmazonLink(asin) : buildAmazonSearchLink(title);

  return `
    <div class="product-card">
      <div class="relative bg-slate-100 aspect-square">
        ${discount ? `<span class="badge">${discount}</span>` : ""}
        <span class="badge badge-right">Amazon</span>
        <a href="${url}" target="_blank" rel="nofollow" onclick="trackDeal('${asin}')">
          <img src="${img}" class="w-full h-full object-contain p-4" loading="lazy">
        </a>
      </div>
      <div class="p-3 flex flex-col gap-1.5">
        <div class="text-xs font-bold line-clamp-2">${title}</div>
        <div class="flex items-center justify-between text-[11px]">
          <span class="price">${cur}${price}</span>
          ${oldp ? `<span class="line-through text-slate-400">${oldp}</span>` : ""}
        </div>
        <div class="text-[11px] text-slate-500">‚≠ê ${rating} (${count})</div>
      </div>
    </div>
  `;
}

function renderList(){
  const onlyActive = document.getElementById("onlyActive").checked;
  const listEl = document.getElementById("list");

  let list = promos.slice();

  if (currentCategory !== "All"){
    list = list.filter(p => (p.category || "") === currentCategory);
  }

  // ËøáÊúüÈöêËóèÔºöÈªòËÆ§Âè™ÊòæÁ§∫ activeÔºõÂ¶ÇÊûúÂÖ≥Êéâ onlyActiveÔºåÂ∞±ÊòæÁ§∫ active+upcomingÔºà‰ªçÈöêËóè expiredÔºâ
  list = list.filter(p => {
    const st = promoStatus(p);
    if (st === "expired") return false;          // ‚úÖ Ê∞∏ËøúÈöêËóèËøáÊúü
    if (onlyActive) return st === "active";      // ‚úÖ Active only
    return st === "active" || st === "upcoming"; // ‚úÖ Active + Upcoming
  });

  // ÊéíÂ∫èÔºöactive Âú®ÂâçÔºõÂø´ÁªìÊùüÂú®ÂâçÔºõÊäòÊâ£È´òÂú®Ââç
  list.sort((a,b)=>{
    const sa = promoStatus(a), sb = promoStatus(b);
    if (sa !== sb) return sa === "active" ? -1 : 1;
    const ea = parseMs(a.end_at), eb = parseMs(b.end_at);
    if (ea && eb && ea !== eb) return ea - eb;
    return Number(b.discount_percent||0) - Number(a.discount_percent||0);
  });

  document.getElementById("stats").innerText =
    `${list.length} promos shown ¬∑ ${promos.length} total`;

  listEl.innerHTML = list.length
    ? list.map(promoCard).join("")
    : `<div class="card p-6 text-slate-500">No promo codes found for this filter.</div>`;
}

/* =============================
   Tracking (GA optional)
============================= */
function trackShop(brand, code){
  try{
    gtag('event', 'select_promo', { brand, promo_code: code });
  }catch(e){}
}
function trackDeal(asin){
  try{
    gtag('event', 'select_item', { item_id: asin || "" });
  }catch(e){}
}

/* =============================
   Global binding
============================= */
window.copyCodeGlobal = copyCode;
window.trackShop = trackShop;
window.trackDeal = trackDeal;

/* =============================
   Init
============================= */
async function init(){
  const [promoRes, productRes] = await Promise.all([
    fetch(PROMO_URL),
    fetch(PRODUCTS_URL),
  ]);

  promos = await promoRes.json();
  products = await productRes.json();

  // ÂÖºÂÆπÂ≠óÊÆµÂêçÔºö‰Ω† Vipon JSON ÈáåÊòØ category_name
  products = products.map(p => ({
    ...p,
    category_name: p.category_name || p.category || ""
  }));

  renderCategoryDropdown();

  document.getElementById("onlyActive").onchange = renderList;

  renderList();
}

init();
</script>

</body>
</html>
