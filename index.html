<!DOCTYPE html>
<html lang="es">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D5YSD14H3P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D5YSD14H3P');
  </script>

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global Finds â€“ Best Amazon Deals</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

<style>
:root{--dark:#111827;--accent:#f97316;--soft:#ffedd5}
.product-card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;overflow:hidden;transition:.25s}
.product-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,.08)}
.badge{position:absolute;top:10px;left:10px;background:var(--accent);color:#fff;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px}
.badge-right{right:10px;left:auto;background:#000;font-size:10px}
.price{background:var(--soft);color:#9a3412;font-size:12px;font-weight:700;padding:4px 8px;border-radius:8px}
.cta{background:var(--dark);color:var(--accent);font-weight:800;padding:10px;border-radius:10px;text-align:center}
.tab-active{color:var(--accent);border-bottom:3px solid var(--accent)}
.dot-active{width:24px!important;background:var(--accent)!important;border-radius:4px}

/* âœ… æ–°å¢ï¼šPROMO CODE å¼ºæ ‡è®° */
.badge-promo{
  position:absolute;
  top:10px;
  right:10px;
  left:auto;
  background:#16a34a;
  color:#fff;
  font-size:10px;
  font-weight:900;
  padding:4px 10px;
  border-radius:999px;
  box-shadow:0 8px 20px rgba(22,163,74,.25);
  letter-spacing:.3px;
}
.promo-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  font-weight:900;
  color:#166534;
  background:#dcfce7;
  border:1px solid #86efac;
  padding:4px 8px;
  border-radius:999px;
}

/* âœ… æ–°å¢ï¼šæœç´¢æ¡†å¾®è°ƒ */
.searchbox{
  border:1px solid #cbd5e1;
  border-radius:14px;
  padding:10px 12px;
  font-size:14px;
  font-weight:700;
  outline:none;
}
.searchbox:focus{
  box-shadow:0 0 0 2px rgba(249,115,22,.35);
  border-color:#fb923c;
}

/* debug */
/* âœ… å·²æŒ‰ä½ è¦æ±‚åˆ é™¤ debugï¼ˆæ ·å¼ä¿ç•™ä¸ºæ³¨é‡Šå ä½ï¼Œä¸å½±å“å…¶å®ƒé€»è¾‘ï¼‰ */
</style>
</head>

<body class="bg-slate-50 text-slate-900">

<div class="bg-slate-800 text-slate-300 text-[10px] py-1 text-center">
  Como Afiliado de Amazon, gano con las compras que cumplan los requisitos.
</div>

<nav class="bg-white border-b px-4 py-3 sticky top-0 z-50">
  <div class="max-w-7xl mx-auto flex items-center gap-2">
    <i class="fa-solid fa-bag-shopping text-orange-500 text-2xl"></i>
    <span class="text-xl font-extrabold">
      GLOBAL<span class="text-orange-500">FINDS</span>
    </span>
  </div>
</nav>

<main class="max-w-7xl mx-auto px-4 py-6">

  <!-- Tabs -->
  <div class="flex gap-6 mb-6 border-b">
    <button id="tabDeals" class="pb-3 font-black tab-active">ğŸ”¥ Featured Deals</button>
    <button id="tabPromo" class="pb-3 font-black">ğŸŸï¸ Active Promo Codes</button>
  </div>

  <!-- PROMO SECTION -->
  <section id="promo-section" class="hidden mb-10">
    <div class="flex items-center justify-between mb-4 gap-4">
      <div class="flex items-center gap-4">
        <h2 class="text-lg font-black">ğŸŸï¸ Active Promo Codes</h2>
        <div id="promo-dots" class="flex gap-1.5"></div>
      </div>

      <select id="promoCategorySelect"
        class="border border-slate-300 rounded-xl px-3 py-2 text-sm font-semibold outline-none focus:ring-2 focus:ring-orange-500">
      </select>
    </div>

    <div id="promo-empty" class="hidden border border-slate-200 bg-white rounded-2xl p-6 text-sm text-slate-600">
      æš‚æ— å¯ç”¨ Promoï¼ˆå¯èƒ½æ˜¯æ—¥æœŸæ ¼å¼è§£æå¤±è´¥æˆ–å…¨éƒ¨ä¸åœ¨æœ‰æ•ˆæœŸï¼‰ã€‚
    </div>

    <div id="promo-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>

  <!-- DEAL SECTION -->
  <section id="deal-section">
    <div class="flex items-center justify-between mb-6 gap-4 flex-wrap">
      <h2 class="text-xl font-black">ğŸ”¥ Featured Deals</h2>

      <!-- âœ… æ–°å¢ï¼šæœç´¢æ¡†ï¼ˆä¸å½±å“åŸæœ‰é€‰æ‹©å™¨ï¼‰ -->
      <div class="flex items-center gap-3 w-full md:w-auto">
        <div class="relative flex-1 md:w-[360px]">
          <i class="fa-solid fa-magnifying-glass text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
          <input id="searchInput" class="searchbox w-full pl-11 pr-10"
            placeholder="Buscar producto / ASIN / palabra clave..." />
          <button id="clearSearchBtn"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-700 font-black"
            title="Clear">âœ•</button>
        </div>

        <select id="categorySelect"
          class="border border-slate-300 rounded-xl px-4 py-2 text-sm font-semibold outline-none focus:ring-2 focus:ring-orange-500">
        </select>
      </div>
    </div>

    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-4"></div>
  </section>

</main>

<script>
/* ================= CONFIG ================= */
// âœ… ä½ è¦æ±‚ï¼šTRACK_ID ä¸å¸¦å°¾æ¤ï¼Œå°¾æ¤ç”± marketplace å†³å®š
const TRACK_ID = "site_esfinds";
const PRODUCT_URL = "products_data_v.json";
const PROMO_URL   = "promo_codes.json";

// âœ… marketplace => domain / tag suffix
const AMAZON_DOMAIN_MAP = {
  US: "amazon.com",
  CA: "amazon.ca",
  ES: "amazon.es",
  DE: "amazon.de",
  FR: "amazon.fr",
  IT: "amazon.it",
  UK: "amazon.co.uk",
  GB: "amazon.co.uk",
  JP: "amazon.co.jp"
};
const AMAZON_TAG_SUFFIX_MAP = {
  US: "-20",
  CA: "-20",
  ES: "-21",
  DE: "-21",
  FR: "-21",
  IT: "-21",
  UK: "-21",
  GB: "-21",
  JP: "-22"
};

/* âœ… æ— é™åŠ è½½å‚æ•° */
const PRODUCTS_PER_BATCH = 120;
let _sortedFilteredProducts = [];
let _renderedCount = 0;
let _observer = null;
let _sentinel = null;

/* ================= DOM ================= */
const promoSection = document.getElementById("promo-section");
const dealSection  = document.getElementById("deal-section");
const tabDeals     = document.getElementById("tabDeals");
const tabPromo     = document.getElementById("tabPromo");
const promoEmpty   = document.getElementById("promo-empty");

/* âœ… æ–°å¢ï¼šæœç´¢ DOM */
const searchInput = document.getElementById("searchInput");
const clearSearchBtn = document.getElementById("clearSearchBtn");

/* ================= STATE ================= */
let allProducts = [];
let allPromosRaw = [];
let allPromosActive = [];
let currentCategory = "All";
let promoPage = 0;
const PROMOS_PER_PAGE = 3;

/* âœ… æ–°å¢ï¼šæœç´¢çŠ¶æ€ */
let searchQuery = "";

/* ================= UTILS ================= */
function buildLink(asin){
  const p = allProducts.find(x => (x.asin || "") === asin);

  // 1) ä¼˜å…ˆ affiliate_link
  if (p && p.affiliate_link) return p.affiliate_link;

  // 2) marketplace => domain / suffix
  const mp = ((p && p.marketplace) ? p.marketplace : "ES").toUpperCase();
  const domain = AMAZON_DOMAIN_MAP[mp] || "amazon.es";
  const suffix = AMAZON_TAG_SUFFIX_MAP[mp] || "-21";

  return `https://www.${domain}/dp/${asin}?tag=${TRACK_ID}${suffix}`;
}

function now(){ return new Date(); }
function formatPrice(v){ return Number(v||0).toFixed(2); }
function formatRating(v){ return v ? Number(v).toFixed(1) : "N/A"; }

function parseDateSmart(input){
  if(!input) return null;
  if(input instanceof Date) return input;
  let s = String(input).trim();
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(s)) {
    s = s.replace(/\s+/, "T");
  }
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    s = s + "T00:00:00";
  }
  const d = new Date(s);
  if (isNaN(d.getTime())) return null;
  return d;
}

function isPromoActive(p){
  let st = parseAmazonRawDate(p.raw_text, "start");
  let ed = parseAmazonRawDate(p.raw_text, "end");

  if(!st) st = parseDateSmart(p.start_at || p.startAt || p.start);
  if(!ed) ed = parseDateSmart(p.end_at   || p.endAt   || p.end);

  if(!st || !ed) return false;

  const t = Date.now();
  return st.getTime() <= t && t <= ed.getTime();
}

/* ================= TAB SWITCH ================= */
tabDeals.onclick = () => {
  dealSection.classList.remove("hidden");
  promoSection.classList.add("hidden");
  tabDeals.classList.add("tab-active");
  tabPromo.classList.remove("tab-active");
};

tabPromo.onclick = () => {
  promoSection.classList.remove("hidden");
  dealSection.classList.add("hidden");
  tabPromo.classList.add("tab-active");
  tabDeals.classList.remove("tab-active");
};

/* ================= PROMO ================= */
function renderPromoCategories(promos){
  const sel = document.getElementById("promoCategorySelect");
  const cats = [...new Set(promos.map(p=>p.category).filter(Boolean))].sort();
  sel.innerHTML = `<option value="All">All Categories</option>`;
  cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
  sel.onchange = () => { promoPage = 0; renderPromos(sel.value); };
}

function renderPromos(cat="All"){
  const list = document.getElementById("promo-list");
  const empty = document.getElementById("promo-empty");
  list.innerHTML = "";

  const filtered = allPromosActive.filter(p => cat==="All" || p.category===cat);

  if(!filtered.length){
    empty.classList.remove("hidden"); return;
  }
  empty.classList.add("hidden");

  filtered.forEach(p => {
    const ed = parseAmazonRawDate(p.raw_text, "end");
    const endText = ed ? ed.toLocaleDateString() : "Limited Time";

    const div = document.createElement("div");
    div.className = "group border-2 border-slate-100 hover:border-orange-500 rounded-2xl bg-white p-4 transition-all cursor-pointer flex flex-col gap-2";
    div.onclick = () => copyAndGo(p);
    div.innerHTML = `
      <div class="flex justify-between items-start">
        <span class="text-[10px] font-bold uppercase text-orange-500">${p.category || "PROMO"}</span>
        <span class="text-[10px] text-slate-400">Ends ${endText}</span>
      </div>
      <div class="text-sm font-bold text-slate-800">Save ${p.discount_percent}% on ${p.brand || "Selected Items"}</div>
      <div class="mt-2 flex items-center justify-between bg-slate-50 border border-dashed border-slate-300 rounded-lg p-2 group-hover:bg-orange-50 group-hover:border-orange-200">
        <code class="text-sm font-mono font-black text-slate-700">${p.promo_code}</code>
        <span class="text-[10px] font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded">TAP TO COPY</span>
      </div>
    `;
    list.appendChild(div);
  });
}

function toast(msg){
  const t=document.createElement("div");
  t.className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full z-[100] text-sm font-bold shadow-xl";
  t.innerText=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1200);
}

function copyAndGo(p){
  const code = p.promo_code || "";
  const link = p.link || "";

  if(code){
    navigator.clipboard?.writeText(code).catch(()=>{});
    toast(`Code ${code} Copied!`);
  }else{
    toast("Copied!");
  }

  setTimeout(()=>{
    if(link){
      window.open(link, "_blank");
      return;
    }
    const brand = (p.brand || "").toLowerCase().trim();
    if(brand){
      const match = allProducts.find(x => (x.title||"").toLowerCase().includes(brand));
      if(match?.asin){
        window.open(buildLink(match.asin), "_blank");
        return;
      }
    }
    window.open("https://www.amazon.es/?tag="+TRACK_ID+(AMAZON_TAG_SUFFIX_MAP["ES"]||"-21"), "_blank");
  }, 350);
}

/* ================= PRODUCTS ================= */
function scoreProduct(p){
  const rating = Number(p.review_rating || 0);
  const reviews = Math.log10((p.review_count || 0) + 1);
  const price = Number(p.price_discount || 999);
  const priceFactor = price > 0 ? 1 / Math.sqrt(price) : 0;
  return rating * reviews * priceFactor + Math.random()*0.15;
}

/* âœ… æ–°å¢ï¼šæœç´¢åŒ¹é…ï¼ˆæ ‡é¢˜/ASIN/åˆ†ç±»/å“ç‰Œå­—æ®µå¦‚æœä½ æœ‰ï¼‰ */
function matchSearch(p, q){
  if(!q) return true;
  const s = q.toLowerCase();
  const title = (p.title || "").toLowerCase();
  const asin  = (p.asin  || "").toLowerCase();
  const cat   = (p.category_name || "").toLowerCase();
  const mp    = (p.marketplace || "").toLowerCase();
  return title.includes(s) || asin.includes(s) || cat.includes(s) || mp.includes(s);
}

function getFilteredSortedList(){
  let list = currentCategory === "All"
    ? allProducts
    : allProducts.filter(p=>p.category_name === currentCategory);

  /* âœ… æ–°å¢ï¼šæœç´¢è¿‡æ»¤ */
  list = list.filter(p => matchSearch(p, searchQuery));

  return list
    .map(p=>({...p,_s:scoreProduct(p)}))
    .sort((a,b)=>{
      const aMp = (a.marketplace || "").toUpperCase();
      const bMp = (b.marketplace || "").toUpperCase();
      if (aMp === "ES" && bMp !== "ES") return -1;
      if (aMp !== "ES" && bMp === "ES") return 1;
      return b._s-a._s;
    });
}

function ensureInfiniteObserver(){
  const grid = document.getElementById("product-grid");

  if(!_sentinel){
    _sentinel = document.createElement("div");
    _sentinel.id = "infinite-sentinel";
    _sentinel.className = "w-full col-span-full h-10";
    grid.parentElement.appendChild(_sentinel);
  }

  if(_observer){
    try{ _observer.disconnect(); }catch(e){}
    _observer = null;
  }

  _observer = new IntersectionObserver((entries)=>{
    const e = entries && entries[0];
    if(!e || !e.isIntersecting) return;
    appendNextBatch();
  },{
    root: null,
    rootMargin: "800px",
    threshold: 0.01
  });

  _observer.observe(_sentinel);
}

function appendNextBatch(){
  const grid=document.getElementById("product-grid");
  if(!_sortedFilteredProducts || !_sortedFilteredProducts.length) return;
  if(_renderedCount >= _sortedFilteredProducts.length) return;

  const next = _sortedFilteredProducts.slice(_renderedCount, _renderedCount + PRODUCTS_PER_BATCH);
  _renderedCount += next.length;

  next.forEach(p=>{
    const d=document.createElement("div");
    d.className="product-card";

    const cur = (p.currency && String(p.currency).trim()) ? String(p.currency).trim() : (
      (String(p.marketplace||"").toUpperCase()==="ES" || String(p.marketplace||"").toUpperCase()==="DE" || String(p.marketplace||"").toUpperCase()==="FR" || String(p.marketplace||"").toUpperCase()==="IT") ? "â‚¬" : "$"
    );

    /* âœ… æ–°å¢ï¼šcoupon_type ä¸º Promo Code é‡ç‚¹æ ‡è®° */
    const isPromoCode = (String(p.coupon_type || "").toLowerCase().trim() === "promo code");

    d.innerHTML=`
      <div class="relative bg-slate-100 aspect-square">
        ${p.discount_percent?`<span class="badge">-${p.discount_percent}%</span>`:""}
        <span class="badge badge-right">Amazon</span>
        ${isPromoCode?`<span class="badge-promo">PROMO CODE</span>`:""}
        <a href="${buildLink(p.asin)}" target="_blank" rel="noopener">
          <img src="${p.main_image}" class="w-full h-full object-contain p-6" loading="lazy">
        </a>
      </div>
      <div class="p-4 flex flex-col gap-2">
        <h3 class="text-sm font-bold leading-snug line-clamp-3 min-h-[3.6em]">${p.title || ""}</h3>
${isPromoCode?`
  <div class="flex items-center justify-between">
    <span class="promo-chip">ğŸŸï¸ Promo Code</span>
  </div>
`:""}


        <div class="flex justify-between items-center mt-auto">
          <span class="price">${cur}${formatPrice(p.price_discount)}</span>
          ${p.price_original?`<span class="line-through text-slate-400 text-[10px]">${cur}${formatPrice(p.price_original)}</span>`:""}
        </div>
        <div class="text-[11px] text-slate-500">
          â­ ${formatRating(p.review_rating)} (${p.review_count||0})
        </div>
        <a href="${buildLink(p.asin)}" target="_blank" rel="noopener" class="cta text-xs">View Deal</a>
      </div>`;
    grid.appendChild(d);
  });
}

function renderProducts(){
  const grid=document.getElementById("product-grid");
  grid.innerHTML="";

  _sortedFilteredProducts = getFilteredSortedList();
  _renderedCount = 0;

  ensureInfiniteObserver();
  appendNextBatch();
}

function renderCategorySelect(cats){
  const sel=document.getElementById("categorySelect");
  sel.innerHTML=`<option>All</option>`;
  cats.forEach(c=>sel.innerHTML+=`<option>${c}</option>`);
  sel.onchange=()=>{currentCategory=sel.value;renderProducts();}
}

function parseAmazonRawDate(raw, type){
  if(!raw) return null;

  const reg = type === "start"
    ? /Start Date:\s*([A-Za-z]{3}\s+\d{2},\s+\d{4}\s+at\s+\d{1,2}:\d{2}\s+[AP]M)\s+(PST|PDT)/i
    : /End Date:\s*([A-Za-z]{3}\s+\d{2},\s+\d{4}\s+at\s+\d{1,2}:\d{2}\s+[AP]M)\s+(PST|PDT)/i;

  const m = raw.match(reg);
  if(!m) return null;

  const datePart = m[1].replace(" at ", " ");
  const tz = m[2] === "PDT" ? "-07:00" : "-08:00";
  const d = new Date(`${datePart} ${tz}`);
  return isNaN(d) ? null : d;
}

/* ================= SEARCH HOOK ================= */
/* âœ… æ–°å¢ï¼šæœç´¢ï¼ˆé˜²æŠ–ï¼Œä¸å½±å“å…¶å®ƒé€»è¾‘ï¼‰ */
let _searchTimer = null;
function setSearch(q){
  searchQuery = (q || "").trim();
  renderProducts();
}
searchInput.addEventListener("input", (e)=>{
  const v = e.target.value || "";
  if(_searchTimer) clearTimeout(_searchTimer);
  _searchTimer = setTimeout(()=>setSearch(v), 180);
});
clearSearchBtn.onclick = ()=>{
  searchInput.value = "";
  setSearch("");
};

/* ================= INIT ================= */
async function init(){
  try{
    allPromosRaw = allPromosRaw.map(p=>{
      if(!p.category && p.raw_text){
        p.category = p.raw_text.split("\n")[0].trim();
      }
      return p;
    });

    const [pRes, promoRes] = await Promise.all([fetch(PRODUCT_URL), fetch(PROMO_URL)]);
    if(!pRes.ok) throw new Error(`products fetch failed: ${pRes.status}`);
    if(!promoRes.ok) throw new Error(`promo fetch failed: ${promoRes.status}`);

    const [pData, promoData] = await Promise.all([pRes.json(), promoRes.json()]);

    allProducts = Array.isArray(pData) ? pData : (pData?.data || []);
    allPromosRaw = Array.isArray(promoData) ? promoData : (promoData?.data || []);

    let invalidCount = 0;
    allPromosActive = allPromosRaw.filter(p=>{
      const st = parseDateSmart(p.start_at || p.startAt || p.start);
      const ed = parseDateSmart(p.end_at || p.endAt || p.end);
      if(!st || !ed) invalidCount++;
      return isPromoActive(p);
    });

    renderPromoCategories(allPromosRaw.length ? allPromosRaw : allPromosActive);
    renderPromos("All");

    const cats=[...new Set(allProducts.map(p=>p.category_name).filter(Boolean))].sort();
    renderCategorySelect(cats);
    renderProducts();

  }catch(e){
    console.error(e);
    tabPromo.click();
    promoEmpty.classList.remove("hidden");
    promoEmpty.innerText = "åˆå§‹åŒ–å¤±è´¥ï¼šè¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ï¼ˆå¸¸è§ï¼šjson 404 æˆ–è·¨åŸŸï¼‰ã€‚";
  }
}

init();
</script>

</body>
</html>
